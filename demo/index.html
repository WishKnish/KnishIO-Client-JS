<html>
<head>
  <title>VanillaJS Test</title>
  <script
    type="text/javascript"
    src="../dist/client.iife.js"
  ></script>
  <script
    type="text/javascript"
    src="json-formatter/json-formatter.umd.js"
  ></script>
  <link
    href="prettify/prettify.css"
    type="text/css"
    rel="stylesheet"
  />
  <script
    type="text/javascript"
    src="prettify/prettify.js"
  ></script>
  <style type="text/css">
    body {
      display: flex;
      flex-flow: row wrap;
    }

    #content > div, #output > div {
      padding: 10px;
    }

    #content {
      display: flex;
      flex-flow: column;
      width: 50%;
    }

    #output {
      display: flex;
      flex-flow: column;
      width: 50%;
    }

    .prettyprint {
      width: 100% !important;
      display: block;
      overflow: auto;
    }
  </style>
</head>
<body onload="prettyPrint()">
<div id="content">
  <h4>Inputs</h4>
  <div>
    <strong>Step 1: Initialize client</strong>
    <pre class="prettyprint">
const client = new KnishIO.KnishIOClient({uri: 'https://eteplitsky.testnet.knish.io/graphql', cellSlug: 'TESTCELL' });
    </pre>
    <hr />

    <strong>Step 2: Authenticate</strong>
    <pre class="prettyprint">
const secret = KnishIO.generateSecret('foo');
client.requestAuthToken({ secret });
    </pre>
    <hr />

    <strong>Step 3: Request Metadata</strong>
    <pre class="prettyprint">
client.queryMeta( {
  metaType: 'WalletBundle', // Or some other metaType
  metaId: 'BUNDLE_HASH_GOES_HERE', // Or some other metaId
  latest: true,
  latestMetas: true,
  throughAtom: true
} ).then( response => {
  ...
} )
    </pre>
    <div>
      <label for="metaType">MetaType:</label> <input
      type="text"
      id="metaType"
      name="metaType"
      value="WalletBundle"
    >
    </div>
    <div>
      <label for="metaId">MetaID:</label> <input
      type="text"
      id="metaId"
      name="metaId"
      value=""
    >
    </div>
    <div>
      <input
        type="submit"
        value="Request Metadata"
        onclick="handleMetaQuery()"
      >
    </div>
    <hr />
    <strong>Step 4: Record New Metadata</strong>
    <pre class="prettyprint">
client.createMeta( {
  metaType: 'WalletBundle', // Or some other metaType
  metaId: 'BUNDLE_HASH_GOES_HERE', // Or some other metaId
  meta: {
    'foo': 'bar',
    'baz': 'qux',
    ...
  }
} ).then( response => {
  ...
} )
    </pre>
    <div>
      <label for="key">Key:</label> <input
      type="text"
      id="key"
      name="key"
    >
    </div>
    <div>
      <label for="value">Value:</label> <input
      type="text"
      id="value"
      name="value"
    >
    </div>
    <div>
      <input
        type="submit"
        value="Write Metadata"
        onclick="handleMetaCreate()"
      >
    </div>
  </div>
</div>
<div id="output">
  <h4>Outputs</h4>
  <div>
    <div><span id="response"></span></div>
  </div>
</div>
<script type="text/javascript">
  handleResponse( 'Initializing client...' )
  const client = new KnishIO.KnishIOClient( {
    uri: 'https://eteplitsky.testnet.knish.io/graphql',
    cellSlug: 'TESTCELL'
  } );
  handleResponse( { uri: client.uri() } );

  handleResponse( 'Generating fingerprint...');
  client.getFingerprint().then( fingerprint => {

    handleResponse( { fingerprint } );

    handleResponse( 'Generating secret based on fingerprint...' );
    const secret = KnishIO.generateSecret( fingerprint );
    handleResponse( { secret } );

    handleResponse( 'Requesting auth token...' );
    client.requestAuthToken( { secret } ).then( () => {
      handleResponse( { authToken: client.getAuthToken() } )
    } );

    handleResponse( 'Generating bundle hash...' )
    const bundle = client.getBundle()
    handleResponse( { bundleHash: bundle } );
    document.getElementById( 'metaId' ).value = bundle

  } );

  function decycle ( obj, stack = [] ) {
    if ( !obj || typeof obj !== 'object' )
      return obj;

    if ( stack.includes( obj ) )
      return null;

    let s = stack.concat( [ obj ] );

    return Array.isArray( obj )
      ? obj.map( x => decycle( x, s ) )
      : Object.fromEntries(
        Object.entries( obj )
          .map( ( [ k, v ] ) => [ k, decycle( v, s ) ] ) );
  }

  function handleResponse ( response ) {
    const formatter = new JSONFormatter( decycle( response ) );
    document.getElementById( 'response' ).appendChild( formatter.render() );
  }

  function handleMetaQuery () {
    const metaType = document.getElementById( 'metaType' ).value;
    const metaId = document.getElementById( 'metaId' ).value;

    if ( !metaType ) {
      alert( 'MetaType required at minimum' )
      return false;
    }

    handleResponse( 'Querying ' + metaType + ':' + metaId );
    client.queryMeta( {
      metaType,
      metaId,
      latest: true,
      latestMetas: true,
      throughAtom: true
    } ).then( response => {
      handleResponse( response );
    } )

  }

  function handleMetaCreate () {
    const metaType = document.getElementById( 'metaType' ).value;
    const metaId = document.getElementById( 'metaId' ).value;
    const key = document.getElementById( 'key' ).value;
    const value = document.getElementById( 'value' ).value;

    if ( !metaType || !metaId || !key || !value ) {
      alert( 'metaType, metaId, key and value required' )
      return false;
    }

    handleResponse( 'Writing ' + key + ':' + value + ' to ' + metaType + ':' + metaId );
    const meta = {};
    meta[key] = value;
    client.createMeta( {
      metaType,
      metaId,
      meta
    } ).then( response => {
      handleResponse( response );
    } )

  }
</script>
</body>
</html>
